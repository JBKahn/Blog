<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>For a Few Ansible Modules More &#8211; A Byte Of The Apple</title>
<meta name="description" content="Creating custom modules in Ansible">
<meta name="keywords" content="post">


<!-- Twitter Cards -->
<meta name="twitter:title" content="For a Few Ansible Modules More">
<meta name="twitter:description" content="Creating custom modules in Ansible">
<meta name="twitter:site" content="@JosephBKahn">
<meta name="twitter:creator" content="@JosephBKahn">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.josephkahn.io/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="For a Few Ansible Modules More">
<meta property="og:description" content="Creating custom modules in Ansible">
<meta property="og:url" content="https://blog.josephkahn.io/articles/ansible-modules/">
<meta property="og:site_name" content="A Byte Of The Apple">





<link rel="canonical" href="https://blog.josephkahn.io/articles/ansible-modules/">
<link href="https://blog.josephkahn.io/feed.xml" type="application/atom+xml" rel="alternate" title="A Byte Of The Apple Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://blog.josephkahn.io/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://blog.josephkahn.io/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://blog.josephkahn.io/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="https://blog.josephkahn.io/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://blog.josephkahn.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://blog.josephkahn.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://blog.josephkahn.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://blog.josephkahn.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://blog.josephkahn.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://blog.josephkahn.io/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="https://blog.josephkahn.io/about/" >About</a></li>
		  
		    
		    <li><a href="https://blog.josephkahn.io/articles/" >Articles</a></li>
		  
		    
		    <li><a href="http://josephkahn.io" target="_blank">My Website</a></li>
		  
		    
		    <li><a href="https://blog.josephkahn.io/feed.xml" >Feed</a></li>
		  
		    
		    <li><a href="https://blog.josephkahn.io/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="https://blog.josephkahn.io/">A Byte Of The Apple</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Becoming A Better Developer One Mistake At A Time</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="https://blog.josephkahn.io/tags/#post" title="Pages tagged post">post</a></li>
        </ul>
        
          <h1 class="entry-title">For a Few Ansible Modules More</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="https://blog.josephkahn.io/images/bio-photo.jpg" class="bio-photo" alt="Joseph Kahn bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Joseph Kahn</span></span>
        <span class="entry-date date published"><time datetime="2014-08-17T00:00:00-04:00"><i class="fa fa-calendar-o"></i> August 17, 2014</time></span>
        <span class="entry-date date modified"><time datetime="2014-08-17"><i class="fa fa-pencil"></i> August 17, 2014</time></span>
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=post&amp;text=For%20a%20Few%20Ansible%20Modules%20More&amp;url=https://blog.josephkahn.io/articles/ansible-modules/&amp;via=JosephBKahn" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.josephkahn.io/articles/ansible-modules/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=https://blog.josephkahn.io/articles/ansible-modules/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <h1 id="introduction">Introduction</h1>

<p>Before I get into the article, I’d like to thank <a href="http://mattjaynes.com/">Matt Jaynes</a> for featuring my last article in <a href="https://devopsu.com/newsletters/ansible-weekly/43.html">issue 43 of Anisble Weekly</a>. That was a great surprise and hopefully got me a few more readers. Now back to the post.</p>

<p>Once again, school has kept me busy. I’ve since finished taking <a href="http://www.cs.utoronto.ca/~lalla/csc373/index.html">CSC 373 - Algorithm Design, Analysis, and Complexity</a>, completing a final assignment and subsequent exam. I’ve just gotten back to working on the Ansible script that I started a month ago. In case you missed my post from last time, <a href="http://www.ansible.com/home">Ansible</a> is a tool used to deploy and update applications in an easy to use language, using SSH, with no agents to install on remote systems. The specifications for Ansible are all written in YAML, making them well structured and generally easy to follow. Back at Wave, Nathan wrote <a href="http://engineering.waveapps.io/post/80595462671/an-ansible-primer">An Ansible primer</a> blog post on the <a href="http://engineering.waveapps.io/">Wave Engineering blog</a>. A few weeks ago, I wrote a post about using Ansible to setup my local machine: <a href="/articles/ansible/">Ansible or: How I Learned to Stop Wasting Time Setting Up My Computer and Script It</a>. Here, I’ll be taking you through the creation of custom modules, starting with the why.</p>

<p>While writing the YAML for my task files, I found there were a few common tasks I wanted to do that did not have a module wrapper. The easy way to deal with those tasks is to use the <a href="http://docs.ansible.com/command_module.html">Command module</a>. That way I can tell Ansible to execute an arbitrary command on the machine. There are some downsides to doing this, which depend on the specific commands in question. One thing I  like about the output of Ansible is that it can tell me how many commands Ansible executed, previously executed and caused errors  (if I allow them). But yet, arbitrary commands are always run because Ansible has no way to know if they have been executed.</p>

<p>There are two options that I saw to address this, as I wanted to lower the number of changed tasks on repeated runs. I also wanted to prevent some commands from running multiple times. The first is to add another task and use conditional execution. I did that for two of the tasks, however it still had to register a changed task in order to do the check. This led me to look into writing my own modules and I wasn’t able to find many great examples. I should have started with looking at the modules in the Ansible library, but that did not occur to me. In the end I wrote the modules with the help of the docs, the Ansible IRC channel and Ansible library modules. Below I’ll outline writing my own module as well as conditional execution. Note, I’ll be providing specific examples, but there’s a lot more Ansible can do so please check out the docs if you’re interested in using Ansible.</p>

<h1 id="conditional-execution">Conditional Execution</h1>

<p>There isn’t a whole lot to write here, the code is  self explanatory. I wrote this to fix a screen dimming issue on my sager laptop. This particular set of tasks is also conditionally executed, covered by my last blog post.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="nn">---</span>
<span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">screen dimming - alter grub file</span>
  <span class="s">lineinfile</span><span class="pi">:</span>
    <span class="s">dest</span><span class="pi">:</span> <span class="s">/etc/default/grub</span>
    <span class="s">regexp</span><span class="pi">:</span> <span class="s2">"</span><span class="s">^GRUB_CMDLINE_LINUX_DEFAULT="</span>
    <span class="s">line</span><span class="pi">:</span> <span class="s1">'</span><span class="s">GRUB_CMDLINE_LINUX_DEFAULT="quiet</span><span class="nv"> </span><span class="s">splash</span><span class="nv"> </span><span class="s">video.use_native_backlight=1"'</span>
  <span class="s">sudo</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">register</span><span class="pi">:</span> <span class="s">grubfile</span>
  <span class="s">tags</span><span class="pi">:</span> <span class="s">sager</span>

<span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">screen dimming - update grub</span>
  <span class="s">command</span><span class="pi">:</span> <span class="s">sudo update-grub</span>
  <span class="s">sudo</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">when</span><span class="pi">:</span> <span class="s">grubfile|changed</span>
  <span class="s">tags</span><span class="pi">:</span> <span class="s">sager</span>

<span class="c1"># or</span>

<span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">keyboard colors - link clevo-wmi to kernel check</span>
  <span class="s">command</span><span class="pi">:</span> <span class="s">cat /etc/modules</span>
  <span class="s">sudo</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">register</span><span class="pi">:</span> <span class="s">running_modules</span>
  <span class="s">tags</span><span class="pi">:</span> <span class="s">sager</span>

<span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">keyboard colors - link clevo-wmi to kernel</span>
  <span class="s">command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sudo</span><span class="nv"> </span><span class="s">insmod</span><span class="nv"> </span><span class="s">/home//setup/clevo-wmi-code/clevo_wmi.ko"</span>
  <span class="s">sudo</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">when</span><span class="pi">:</span> <span class="s">running_modules.stdout.find('clevo_wmi') == -1</span>
  <span class="s">tags</span><span class="pi">:</span> <span class="s">sager</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="module-writing">Module Writing</h1>

<p>The first thing to work out for a new module is what arguments it will take and how to leverage Ansible to do most of the heavily lifting around it. Here’s the start of my Ansible module for gconftool-2:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">ansible.constants</span> <span class="kn">import</span> <span class="n">mk_boolean</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span>
        <span class="n">argument_spec</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'key'</span><span class="p">:</span> <span class="p">{</span><span class="s">'required'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
            <span class="s">'bool'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'bool'</span><span class="p">},</span>
            <span class="s">'int'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'int'</span><span class="p">},</span>
            <span class="s">'string'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span>
            <span class="s">'float'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'float'</span><span class="p">},</span>
            <span class="s">'list'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">},</span>
            <span class="s">'pair'</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">},</span>
            <span class="s">'pair-cdr-type'</span><span class="p">:</span> <span class="p">{</span><span class="s">'choices'</span><span class="p">:</span> <span class="p">[</span><span class="s">'int'</span><span class="p">,</span> <span class="s">'bool'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">]},</span>
            <span class="s">'pair-car-type'</span><span class="p">:</span> <span class="p">{</span><span class="s">'choices'</span><span class="p">:</span> <span class="p">[</span><span class="s">'int'</span><span class="p">,</span> <span class="s">'bool'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">]},</span>
            <span class="s">'list-type'</span><span class="p">:</span> <span class="p">{</span><span class="s">'choices'</span><span class="p">:</span> <span class="p">[</span><span class="s">'int'</span><span class="p">,</span> <span class="s">'bool'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">]}</span>
        <span class="p">},</span>
        <span class="n">mutually_exclusive</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">,</span> <span class="s">'int'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'list'</span><span class="p">,</span> <span class="s">'pair'</span><span class="p">],</span>
            <span class="p">[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">,</span> <span class="s">'int'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'list-type'</span><span class="p">,</span> <span class="s">'pair'</span><span class="p">],</span>
            <span class="p">[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">,</span> <span class="s">'int'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'list'</span><span class="p">,</span> <span class="s">'pair-car-type'</span><span class="p">],</span>
            <span class="p">[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">,</span> <span class="s">'int'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'list'</span><span class="p">,</span> <span class="s">'pair-cdr-type'</span><span class="p">]</span>
        <span class="p">],</span>
        <span class="n">required_one_of</span><span class="o">=</span><span class="p">[[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'string'</span><span class="p">,</span> <span class="s">'int'</span><span class="p">,</span> <span class="s">'float'</span><span class="p">,</span> <span class="s">'list'</span><span class="p">,</span> <span class="s">'pair'</span><span class="p">]],</span>
        <span class="n">required_together</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[</span><span class="s">'pair'</span><span class="p">,</span> <span class="s">'pair-car-type'</span><span class="p">,</span> <span class="s">'pair-cdr-type'</span><span class="p">],</span>
            <span class="p">[</span><span class="s">'list'</span><span class="p">,</span> <span class="s">'list-type'</span><span class="p">]</span>
        <span class="p">],</span>
        <span class="n">supports_check_mode</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Most of that is pretty easy to follow and it shows a few of the options Ansible handles.  It handles mutual exclusions, requiring one of a set items as well as items which are required together. Additionally, in the <code class="highlighter-rouge">argument_spec</code> you can also define defaults (and more, although this was all that I needed). The <code class="highlighter-rouge">supports_check_mode</code> is a boolean which represents that the module supports dry runs. Now that I’ve defined my argument structure, it’s time to get onto the next piece of code.</p>

<h1 id="the-getter-and-setter">The Getter and Setter</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">argument_type</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">):</span>
    <span class="s">''' Set value of setting, under `key`, using gconftool-2 to `value` of type `argument_type`'''</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">'/usr/bin/gconftool-2 --set --type {} {} "{}" {}'</span>
    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argument_type</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">)]))</span>


<span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="s">''' Return value of setting, under `key`, from gconftool-2'''</span>
    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s">'gconftool-2 --get {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The <code class="highlighter-rouge">module</code> set in the above code block contains some crucial functions, one of which is <code class="highlighter-rouge">run_command</code>. This wraps the native python system library for running commands. It has very good error handling and provides a plethora of input options. Most of those aren’t needed for simple tasks like running <code class="highlighter-rouge">gconftool-2</code>. All I’m doing in the code block is building the command that I’d previously supplied to the Command Module. I’ve already shown how to define the arguments, but now I’ll show how to access them.</p>

<h1 id="argument-accessing">Argument Accessing</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="n">key</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'key'</span><span class="p">]</span>
<span class="n">boolean_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'bool'</span><span class="p">]</span>
<span class="n">string_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'string'</span><span class="p">]</span>
<span class="n">integer_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'int'</span><span class="p">]</span>
<span class="n">float_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'float'</span><span class="p">]</span>
<span class="n">list_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'list'</span><span class="p">]</span>
<span class="n">pair_value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'pair'</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ansible makes arguments extremly easy to access. Now I’ll show you a sample of how I worked with the input.</p>

<h1 id="argument-parsing">Argument Parsing</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="n">additional_args</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">instance_type_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">'int'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'string'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">'float'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s">'bool'</span><span class="p">:</span> <span class="n">mk_boolean</span><span class="p">}</span>
<span class="k">if</span> <span class="n">boolean_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">argument_type</span> <span class="o">=</span> <span class="s">'bool'</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mk_boolean</span><span class="p">(</span><span class="n">boolean_value</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mk_boolean</span><span class="p">(</span><span class="n">old_value</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="o">...</span>
<span class="k">elif</span> <span class="n">float_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">argument_type</span> <span class="o">=</span> <span class="s">'float'</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">float_value</span>
<span class="o">...</span>
<span class="k">elif</span> <span class="n">pair_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">'A pair must be a list of length 2, {} items found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pair_value</span><span class="p">)))</span>
    <span class="n">argument_type</span> <span class="o">=</span> <span class="s">'pair'</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">car_value</span> <span class="o">=</span> <span class="n">pair_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">car_type</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'pair-car-type'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">car_type</span> <span class="o">==</span> <span class="s">'bool'</span><span class="p">:</span>
            <span class="n">module</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">car_value</span><span class="p">)</span>
            <span class="n">car_value</span> <span class="o">=</span> <span class="n">mk_boolean</span><span class="p">(</span><span class="n">car_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance_type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">car_type</span><span class="p">)(</span><span class="n">car_value</span><span class="p">))</span> <span class="o">==</span> <span class="n">car_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span>

        <span class="n">cdr_value</span> <span class="o">=</span> <span class="n">pair_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cdr_type</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'pair-cdr-type'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cdr_type</span> <span class="o">==</span> <span class="s">'bool'</span><span class="p">:</span>
            <span class="n">module</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">cdr_value</span><span class="p">)</span>
            <span class="n">cdr_value</span> <span class="o">=</span> <span class="n">mk_boolean</span><span class="p">(</span><span class="n">cdr_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance_type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cdr_type</span><span class="p">)(</span><span class="n">cdr_value</span><span class="p">))</span> <span class="o">==</span> <span class="n">cdr_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s">'pair type `{}` or `{}` does not match the type of the contents.'</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'pair-car-type'</span><span class="p">],</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'pair-cdr-type'</span><span class="p">]))</span>
    <span class="n">additional_args</span> <span class="o">=</span> <span class="s">'--car-type={} --cdr-type={}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">car_type</span><span class="p">,</span> <span class="n">cdr_type</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">'({},{})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">car_value</span><span class="p">,</span> <span class="n">cdr_value</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>There are a few interesting things to note in this code block. The type specifications works for individual items but there is no equivalent for lists. When I set <code class="highlighter-rouge">pair</code> to type <code class="highlighter-rouge">list</code> it does not support type checking of particular elements or the length of the list. As such, I have to do my own error checking. Fortunately, Ansible provides a <code class="highlighter-rouge">module.fail_json(msg='blah')</code> to use for error reporting back to the console. There is a lot more you can provide than just a message but for my purposes that was perfect. Otherwise I’m just formatting the code to send off to my getter and setter. Now I’ll provide you with the skeleton for the rest of the module.</p>

<h1 id="the-skeleton">The Skeleton</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c">#  module specification</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="n">_get_value</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c"># argument parsing</span>

    <span class="n">changed</span> <span class="o">=</span> <span class="n">old_value</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">changed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
        <span class="n">_set_value</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">argument_type</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">)</span>

    <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span>
        <span class="n">changed</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argument_type</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="n">old_value</span><span class="o">=</span><span class="n">old_value</span>
    <span class="p">)</span>

<span class="n">main</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>As you can see, there isn’t much more to do. That conditional is how I support check mode. All I’m doing here is calling my getter and setter and then using Ansible’s <code class="highlighter-rouge">module.exit_json()</code> to handle to integration with Ansible. It requires the <code class="highlighter-rouge">changed</code> argument and the rest is custom and allows me to decide what gets printed on the screen when things change. It’s also important to note that at the bottom of the file I’m calling the <code class="highlighter-rouge">main</code> function, which is required to run the module. The only other section of the file, which I’ve done so that I may contribute to Ansible, is the documentation at the top of the file.</p>

<h1 id="documentation">Documentation</h1>

<p>The documentation includes ussage information as well as examples, here is an exerpt from the file:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="s">'''
---
module: gconftool-2
version_added: "post 1.7.1"
author: Joseph Kahn
short_description: alter gconftool-2 controlled settings.
description:
   - Set the value of a gconftool-2 controlled setting using a key and a
     string, an integer, a boolean, a pair or a list.
options:
  key:
    description:
      - The key of the gconftool-2 setting to change.
    required: true
  bool:
    description:
      - The boolean value to set the key to.
    required: false
...
'''</span>

<span class="n">EXAMPLES</span> <span class="o">=</span> <span class="s">'''
# Set string value
- gconftool-2: key=/apps/gnome-terminal/global/default_profile string=base-16-monokai-dark

# Set bool value
- gconftool-2: key=/apps/gnome-terminal/profiles/base-16-monokai-dark/use_system_font bool=false

# Set pair value
- gconftool-2: key=/path/to/something pair-car-type=int pair-cdr-type=string pair=1,'Joseph Kahn'
'''</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="usage">Usage</h1>

<p>Using your custom modules is easy to do. Once you create a <code class="highlighter-rouge">custom_modules</code> directory, you can use them within Ansible. All you need to do is provide the <code class="highlighter-rouge">module-path</code> argument like so <code class="highlighter-rouge">--module-path custom_modules</code>.</p>

<p>Once you’ve done that, you can use it like any other Ansible module in your task files. i.e.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">base16 - set default terminal profile</span>
  <span class="s">gconftool-2</span><span class="pi">:</span> <span class="s">key=/apps/gnome-terminal/global/default_profile string=base-16-monokai-dark</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="testing">Testing</h1>

<p>The Ansible repo provides an executable that allows for easy module testing from the command line. It can be invoked with a command like:</p>

<p><code class="highlighter-rouge">~/ansible/hacking/test-module -m ./gconftool-2 -a "key=/path/to/stuff pair-car-type=int pair-cdr-type=string pair=1,'Joseph Kahn'"</code></p>

<p>You can also use breakpoints if you provide the debugger used, i.e.</p>

<p><code class="highlighter-rouge">~/ansible/hacking/test-module -m ./gconftool-2 -a "key=2 list=1,1,true,1 list-type=bool" -D ipdb</code></p>

<p>Running the testing module provides to full generated source file, as well as the standard output information. The output file can be run manually without the use of additional arguments.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Writing a simple Ansible module wasn’t very difficult and requires little code to get the basics up and running. Even with all the error handling and verification done above, the module code is only 117 lines. While I did this for convenience, it’s easy to see how making modules simple to write can help make great provisioning scripts. These modules are relatively easy to follow and integrate seamlessly with the rest of the modules.</p>

<h1 id="thats-it">That’s It</h1>

<p>That’s all you need to get a custom module up and running and reporting changes. I’ll leave you with a few relevant links:</p>

<ul>
  <li><a href="https://github.com/JBKahn/provisioning-local">The Repository</a> (The custom modules are in the <code class="highlighter-rouge">ansible modules</code> folder).</li>
  <li><a href="http://docs.ansible.com/list_of_all_modules.html">Ansible Modules</a>.</li>
</ul>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'abyteoftheapplejbkahn'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="https://blog.josephkahn.io/articles/ansible/" class="btn" title="Ansible or: How I Learned to Stop Wasting Time Setting Up My Computer and Script It">Previous</a>
      
      
        <a href="https://blog.josephkahn.io/articles/vagrant-plugin/" class="btn" title="Vagrant Plugin: Back 2 Tha Hood">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2016 Joseph Kahn. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/JosephBKahn" title="Joseph Kahn on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/josephkahn" title="Joseph Kahn on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	<a href="https://linkedin.com/in/jbkahn" title="Joseph Kahn on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	
	
	
	<a href="https://github.com/JBKahn" title="Joseph Kahn on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="https://blog.josephkahn.io/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'https://blog.josephkahn.io';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://blog.josephkahn.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://blog.josephkahn.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-49300323-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>
